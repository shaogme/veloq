services:
  # Base configuration for the application
  app-base: &app-base
    build:
      context: .
      dockerfile: docker/Dockerfile
    image: veloq-dev
    pull_policy: never
    environment:
      - ROOT_PASSWORD=root # Set your secure password here
    security_opt:
      - seccomp:unconfined # Required for some low-level operations
    cap_add:
      - SYS_PTRACE
      - NET_ADMIN
    tty: true

  # Develop mode: Mounts local directory for hot-reloading (Default)
  dev:
    <<: *app-base
    container_name: veloq-dev
    volumes:
      - .:/root/workspace
      # Mount host SSH public key to temporary location
      - ${USERPROFILE}/.ssh/id_ed25519.pub:/tmp/id_ed25519.pub:ro
      - ./docker/entrypoint.sh:/entrypoint.sh
    ports:
      # SSH port mapping: connect via `ssh root@localhost -p 2222`
      - "2222:22"

  # Standalone mode: Uses code copied into the image (No host mounting)
  standalone:
    <<: *app-base
    container_name: veloq-standalone
    volumes:
      - ${USERPROFILE}/.ssh/id_ed25519.pub:/tmp/id_ed25519.pub:ro
      - ./docker/entrypoint.sh:/entrypoint.sh
    ports:
      - "2223:22"
    profiles:
      - standalone

  # Helper service to update flake.lock on the host
  # Usage: docker-compose run --rm flake-update
  flake-update:
    profiles:
      - tools
    image: nixos/nix:latest
    volumes:
      - ./docker:/work
    working_dir: /work
    entrypoint: /bin/sh -c "echo 'experimental-features = nix-command flakes' >> /etc/nix/nix.conf && nix flake update && chmod 666 flake.lock"
